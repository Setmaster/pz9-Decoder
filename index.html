<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>.pz9 Decoder — Legends Z-A</title>
  <style>
    :root {
      --bg: #0b0f18; --card:#101726; --ink:#e6eefb; --muted:#9fb3d9; --brand:#6aa2ff; --ok:#59d38c; --warn:#ffb86c; --error:#ff6b6b;
    }
    html,body { height: 100%; }
    body { margin: 0; font: 15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu; color: var(--ink); background: radial-gradient(1200px 800px at 20% -10%, #12203a 0%, #0b0f18 35%), var(--bg); }
    .wrap { max-width: 980px; margin: 40px auto; padding: 0 16px; }
    header { display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom: 18px; }
    h1 { font-size: 22px; margin:0; letter-spacing:.3px; display: flex; align-items: center; gap: 8px; }
    .github-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: #142345;
      border: 1px solid #2a4272;
      border-radius: 8px;
      padding: 6px 10px;
      cursor: pointer;
      transition: background 0.2s, border-color 0.2s;
    }
    .github-btn:hover {
      background: #18315f;
      border-color: #3a5fa6;
    }
    .github-btn svg {
      width: 18px;
      height: 18px;
      fill: var(--ink);
    }
    .hint { color: var(--muted); font-size: 13px; }
    .panel { background: var(--card); border: 1px solid #1b2742; border-radius: 14px; padding: 18px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    .uploader { display:grid; grid-template-columns: 1fr auto; gap: 12px; align-items:center; }
    .drop { padding: 18px; border: 2px dashed #27406f; border-radius: 12px; background: #0e1627; text-align:center; color: var(--muted); cursor: pointer; }
    .drop.drag { border-color: var(--brand); color: var(--ink); background: #0c1a33; }
    .btn { appearance:none; border-radius: 10px; border:1px solid #2a4272; padding: 10px 14px; background:#142345; color:var(--ink); cursor:pointer; font-weight:600; }
    .btn:hover{ border-color:#3a5fa6; background:#18315f; }
    .results { margin-top: 18px; display: grid; gap: 12px; }
    .card { background:#0d1426; border:1px solid #1a2744; border-radius: 12px; padding: 14px; }
    .filehead { display:flex; justify-content:space-between; align-items:center; color:var(--muted); font-size:13px; margin-bottom:8px; }
    .grid { display:grid; grid-template-columns: max-content 1fr; gap:6px 14px; }
    .label { color: var(--muted); }
    .val { font-weight: 650; letter-spacing:.2px; }
    .err { color: var(--error); font-weight:600; }
    footer { margin-top: 28px; color: var(--muted); font-size: 12px; text-align:center; }
    code { background:#0c1430; border:1px solid #1a294d; padding:2px 6px; border-radius:6px; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>
        .pz9 Decoder — Web
        <button class="github-btn" title="View on GitHub" onclick="window.open('https://github.com/Setmaster/pz9-Decoder', '_blank')">
          <svg viewBox="0 0 16 16" aria-hidden="true">
            <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 
            6.53 5.47 7.59.4.07.55-.17.55-.38 
            0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52
            0-.53.63-.01 1.08.58 1.23.82.72 1.21 
            1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 
            0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 
            0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 
            0 1.36.09 2 .27 1.53-1.04 2.2-.82 
            2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 
            1.27.82 2.15 0 3.07-1.87 3.75-3.65 
            3.95.29.25.54.73.54 1.48 0 1.07-.01 
            1.93-.01 2.2 0 .21.15.46.55.38A8.013 
            8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path>
          </svg>
        </button>
      </h1>
      <div class="hint">Drop your <code>.pz9</code> files below — runs fully in your browser.</div>
    </header>

    <section class="panel">
      <div class="uploader">
        <div id="drop" class="drop" tabindex="0">Drop .pz9 files here or click to choose</div>
        <input id="file" type="file" accept=".pz9" multiple style="display:none" />
        <button id="pick" class="btn">Choose Files</button>
      </div>
      <div id="status" class="hint" style="margin-top:10px"></div>
      <div id="results" class="results"></div>
    </section>

    <footer>
      Species names are fetched once from PokeAPI. Nothing leaves your computer.
    </footer>
  </div>

<script>
(function(){
  const drop = document.getElementById('drop');
  const pick = document.getElementById('pick');
  const file = document.getElementById('file');
  const results = document.getElementById('results');
  const statusEl = document.getElementById('status');

  let speciesMap = new Map();
  let speciesReady = false;

  async function loadSpeciesMap(){
    try {
      statusEl.textContent = 'Loading species map…';
      const resp = await fetch('https://pokeapi.co/api/v2/pokemon-species/?limit=10000', { cache: 'force-cache' });
      if(!resp.ok) throw new Error(resp.status + ' ' + resp.statusText);
      const data = await resp.json();
      for(const entry of data.results){
        const m = entry.url.match(/\/pokemon-species\/(\d+)\/?$/);
        if(m){
          const id = Number(m[1]);
          const name = entry.name ? (entry.name[0].toUpperCase() + entry.name.slice(1)) : ('SpeciesID ' + id);
          speciesMap.set(id, name);
        }
      }
      speciesReady = true;
      statusEl.textContent = '';
    } catch(err){
      console.warn('Failed to load species map:', err);
      statusEl.textContent = 'Species map failed to load — decoding will still work but species will show as “SpeciesID <id>”.';
      speciesReady = true;
    }
  }

  loadSpeciesMap();

  function readU16LE(view, off){ return view.getUint16(off, true); }
  function readU32LE(view, off){ return view.getUint32(off, true); }

  function findUtf16leStrings(buf, minChars = 2){
    const out = [];
    const td = new TextDecoder('utf-16le', { fatal: false });
    for(const offset of [0,1]){
      const slice = buf.slice(offset);
      const s = td.decode(slice);
      const re = new RegExp(`[A-Za-z0-9 _\\-\\.\\'\\!\\?\\:\\;\\&\\()\\/]{${minChars},}`, 'g');
      let m;
      while((m = re.exec(s))){
        out.push({ offset: offset + m.index * 2, string: m[0] });
      }
    }
    out.sort((a,b)=> a.offset - b.offset || a.string.localeCompare(b.string));
    const seen = new Set();
    const uniq = [];
    for(const ent of out){
      const key = ent.offset + '|' + ent.string;
      if(!seen.has(key)){ seen.add(key); uniq.push(ent); }
    }
    return uniq;
  }

  function speciesNameFromId(id){
    return speciesMap.get(id) || `SpeciesID ${id}`;
  }

  function decodePZ9(arrayBuffer){
    if(arrayBuffer.byteLength !== 344){
      throw new Error(`expected 344 bytes, got ${arrayBuffer.byteLength}`);
    }
    const view = new DataView(arrayBuffer);
    const speciesId = readU16LE(view, 0x08);
    const trainerId32 = readU32LE(view, 0x0C);

    const tid7 = trainerId32 % 1_000_000;
    const tid7str = String(tid7).padStart(6, '0');
    const sid7 = Math.floor(trainerId32 / 1_000_000);

    const strings = findUtf16leStrings(arrayBuffer);
    const nickname = strings.length >= 1 ? strings[0].string : '';

    return {
      species_id: speciesId,
      species_name: speciesNameFromId(speciesId),
      nickname,
      TID7: tid7str,
      SID7: sid7,
    };
  }

  function renderResult(fileName, result){
    const card = document.createElement('div');
    card.className = 'card';
    const head = document.createElement('div');
    head.className = 'filehead';
    head.innerHTML = `<span>${fileName}</span>`;
    card.appendChild(head);

    const grid = document.createElement('div');
    grid.className = 'grid';

    const rows = [
      ['Species:', result.species_name],
      ['Nick:', result.nickname],
      ['TID:', result.TID7],
      ['SID:', String(result.SID7)],
    ];

    for(const [label, val] of rows){
      const l = document.createElement('div'); l.textContent = label; l.className = 'label';
      const v = document.createElement('div'); v.textContent = val; v.className = 'val';
      grid.appendChild(l); grid.appendChild(v);
    }

    card.appendChild(grid);
    results.appendChild(card);
  }

  function renderError(fileName, err){
    const card = document.createElement('div');
    card.className = 'card';
    const head = document.createElement('div');
    head.className = 'filehead';
    head.innerHTML = `<span>${fileName}</span>`;
    const msg = document.createElement('div');
    msg.className = 'err';
    msg.textContent = 'Error: ' + (err && err.message ? err.message : String(err));
    card.appendChild(head);
    card.appendChild(msg);
    results.appendChild(card);
  }

  async function handleFiles(fileList){
    if(!speciesReady){ await Promise.race([new Promise(r=>setTimeout(r, 800)), (async()=>{ while(!speciesReady) await new Promise(r=>setTimeout(r, 50)); })()]); }
    results.innerHTML = '';
    const tasks = Array.from(fileList).filter(f => f.name.toLowerCase().endsWith('.pz9'));
    if(tasks.length === 0){ statusEl.textContent = 'No .pz9 files selected.'; return; }
    statusEl.textContent = `Decoding ${tasks.length} file(s)…`;

    for(const f of tasks){
      try {
        const buf = await f.arrayBuffer();
        const out = decodePZ9(buf);
        renderResult(f.name, out);
      } catch(err){
        renderError(f.name, err);
      }
    }
    statusEl.textContent = '';
  }

  pick.addEventListener('click', ()=> file.click());
  drop.addEventListener('click', ()=> file.click());
  drop.addEventListener('dragover', (e)=>{ e.preventDefault(); drop.classList.add('drag'); });
  drop.addEventListener('dragleave', ()=> drop.classList.remove('drag'));
  drop.addEventListener('drop', (e)=>{ e.preventDefault(); drop.classList.remove('drag'); handleFiles(e.dataTransfer.files); });
  file.addEventListener('change', ()=> handleFiles(file.files));
})();
</script>
</body>
</html>
